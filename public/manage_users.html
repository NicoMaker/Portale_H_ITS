<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Utenti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="navbar"><a href="/admin_dashboard.html">Dashboard Admin</a> &gt; Gestione Utenti</div>
  <div class="container" style="max-width:900px;">
    <div class="form-container" style="box-shadow:none;margin:0 0 2rem 0;">
      <h3 style="margin-bottom:1.2rem;">Aggiungi Utente</h3>
      <form id="add-user-form">
        <input type="text" id="new-username" placeholder="Username" required />
        <input type="password" id="new-password" placeholder="Password" required />
        <div id="add-password-hint" class="hint"></div>
        <select id="new-role" required>
          <option value="user">Utente</option>
          <option value="admin">Amministratore</option>
        </select>
        <select id="new-course" style="display:none;"></select>
        <button type="submit">Crea Utente</button>
        <div id="add-user-msg"></div>
      </form>
    </div>
    <div id="users-list"></div>
    <div id="assign-msg" class="hint"></div>
    <a href="/admin_dashboard.html">Torna alla Dashboard</a>
  </div>
  <div id="edit-user-modal" class="modal" style="display:none">
    <div class="modal-content">
      <span class="close" id="close-edit-modal">&times;</span>
      <h3>Modifica Utente</h3>
      <form id="edit-user-form">
        <input type="text" name="edit_username" id="edit_username" placeholder="Nuovo username" required />
        <input type="password" name="edit_password" id="edit_password" placeholder="Nuova password" required />
        <div id="edit-user-password-hint" class="hint"></div>
        <button type="submit">Salva</button>
        <div id="edit-user-msg"></div>
      </form>
    </div>
  </div>
  <div id="user-schedules-modal" class="modal" style="display:none">
    <div class="modal-content">
      <span class="close" id="close-schedules-modal">&times;</span>
      <h3>Orari assegnati all'utente</h3>
      <div id="user-schedules-content"></div>
    </div>
  </div>
  <script>
    let courses = [];
    let users = [];
    let editingUserId = null;
    function fetchCourses() {
      return fetch('/api/courses').then(r=>r.json()).then(data => { courses = data; updateNewCourseSelect(); });
    }
    function updateNewCourseSelect() {
      const select = document.getElementById('new-course');
      if(document.getElementById('new-role').value === 'user') {
        select.style.display = '';
        select.innerHTML = '<option value="">Nessun corso</option>' + courses.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      } else {
        select.style.display = 'none';
      }
    }
    document.getElementById('new-role').onchange = updateNewCourseSelect;
    function fetchUsers() {
      fetch('/api/users').then(r=>r.json()).then(data => {
        users = data;
        const adminCount = users.filter(u=>u.role==="admin").length;
        let html = '<table><tr><th>Username</th><th>Ruolo</th><th>Corso</th><th>Azioni</th></tr>';
        users.forEach(u => {
          html += `<tr><td>${u.username}</td><td>`;
          html += `<span class='badge ${u.role}'>${u.role === 'admin' ? 'Admin' : 'Utente'}</span>`;
          html += `</td><td>`;
          if(u.role==="user") {
            html += `<select onchange='assignCourse(${u.id}, this.value)' style="min-width:120px;">`;
            html += `<option value="">Nessun corso</option>`;
            courses.forEach(c => {
              const selected = (u.courses && u.courses[0] && u.courses[0].id==c.id) ? 'selected' : '';
              html += `<option value="${c.id}" ${selected}>${c.name}</option>`;
            });
            html += `</select>`;
          } else {
            html += '<span style="color:#888">-</span>';
          }
          html += `</td><td>`;
          html += `<button onclick='openEditUser(${u.id})'>Modifica</button> `;
          if(u.role==="user" && u.courses && u.courses[0]) html += `<button onclick='showUserSchedules(${u.id},${u.courses[0].id})'>Orari</button> `;
          if(u.role!=="admin") html += `<button onclick='promote(${u.id})'>Rendi Admin</button>`;
          if(u.role==="admin" && adminCount>1) html += `<button onclick='demote(${u.id})'>Rendi Utente</button>`;
          if(adminCount>1 || u.role!=="admin") html += `<button onclick='deleteUser(${u.id})'>Elimina</button>`;
          html += `</td></tr>`;
        });
        html += '</table>';
        document.getElementById('users-list').innerHTML = html;
      });
    }
    function promote(id) {
      fetch(`/api/users/${id}/promote`, {method:'POST'}).then(()=>fetchUsers());
    }
    function demote(id) {
      fetch(`/api/users/${id}/demote`, {method:'POST'}).then(()=>fetchUsers());
    }
    function deleteUser(id) {
      if(confirm('Sei sicuro di voler eliminare questo utente?'))
        fetch(`/api/users/${id}`, {method:'DELETE'}).then(()=>fetchUsers());
    }
    function assignCourse(id, courseId) {
      fetch(`/api/users/${id}/assign_course`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({course_id:courseId})})
        .then(r=>r.text())
        .then(msg=>{
          fetchUsers();
          const el = document.getElementById('assign-msg');
          if(msg==='OK') {
            el.textContent = 'Corso assegnato con successo!';
            el.className = 'success';
          } else {
            el.textContent = msg;
            el.className = 'hint';
          }
          setTimeout(()=>{el.textContent='';}, 2500);
        });
    }
    // Modifica utente
    function openEditUser(id) {
      editingUserId = id;
      const user = users.find(u=>u.id===id);
      document.getElementById('edit_username').value = user.username;
      document.getElementById('edit_password').value = '';
      document.getElementById('edit-user-password-hint').textContent = '';
      document.getElementById('edit-user-msg').textContent = '';
      document.getElementById('edit-user-modal').style.display = 'flex';
    }
    document.getElementById('close-edit-modal').onclick = () => {
      document.getElementById('edit-user-modal').style.display = 'none';
    };
    window.onclick = e => {
      if(e.target === document.getElementById('edit-user-modal'))
        document.getElementById('edit-user-modal').style.display = 'none';
      if(e.target === document.getElementById('user-schedules-modal'))
        document.getElementById('user-schedules-modal').style.display = 'none';
    };
    // Validazione password
    const editPassword = document.getElementById('edit_password');
    const editHint = document.getElementById('edit-user-password-hint');
    editPassword.addEventListener('input', () => {
      const val = editPassword.value;
      let msg = '';
      if(val.length < 8) msg += 'Min 8 caratteri. ';
      if(!/[A-Z]/.test(val)) msg += 'Almeno una maiuscola. ';
      if(!/[a-z]/.test(val)) msg += 'Almeno una minuscola. ';
      if(!/[0-9]/.test(val)) msg += 'Almeno un numero. ';
      editHint.textContent = msg;
      editHint.style.color = msg ? 'var(--accent)' : 'green';
    });
    document.getElementById('edit-user-form').onsubmit = function(e) {
      if(editHint.textContent) {
        e.preventDefault();
        editHint.style.color = 'red';
        return false;
      }
      e.preventDefault();
      fetch(`/api/users/${editingUserId}/edit`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({username:document.getElementById('edit_username').value, password:editPassword.value})
      }).then(r=>r.text()).then(msg => {
        document.getElementById('edit-user-msg').textContent = msg;
        if(msg==='OK') setTimeout(()=>{document.getElementById('edit-user-modal').style.display = 'none'; fetchUsers();}, 1000);
      });
    };
    // Orari utente
    function showUserSchedules(userId, courseId) {
      fetch('/api/schedules').then(r=>r.json()).then(schedules => {
        const scheds = schedules.filter(s=>s.course_id==courseId);
        let html = '';
        if (!scheds.length) {
          html = '<div class="hint">Nessun orario trovato per il corso assegnato a questo utente.</div>';
        } else {
          html = '<div style="overflow-x:auto"><table class="schedule-table"><tr><th>Docente</th><th>Aula</th><th>Giorno</th><th>Data</th><th>Inizio</th><th>Fine</th></tr>' +
            scheds.map(s=>`<tr><td>${s.teacher}</td><td>${s.room}</td><td>${s.day}</td><td>${s.date}</td><td>${s.start_time}</td><td>${s.end_time}</td></tr>`).join('') + '</table></div>';
        }
        document.getElementById('user-schedules-content').innerHTML = html;
        document.getElementById('user-schedules-modal').style.display = 'flex';
      });
    }
    document.getElementById('close-schedules-modal').onclick = () => {
      document.getElementById('user-schedules-modal').style.display = 'none';
    };
    // Validazione password live
    const newPassword = document.getElementById('new-password');
    const addHint = document.getElementById('add-password-hint');
    newPassword.addEventListener('input', () => {
      const val = newPassword.value;
      let msg = '';
      if(val.length < 8) msg += 'Min 8 caratteri. ';
      if(!/[A-Z]/.test(val)) msg += 'Almeno una maiuscola. ';
      if(!/[a-z]/.test(val)) msg += 'Almeno una minuscola. ';
      if(!/[0-9]/.test(val)) msg += 'Almeno un numero. ';
      addHint.textContent = msg;
      addHint.style.color = msg ? 'var(--accent)' : 'green';
    });
    document.getElementById('add-user-form').onsubmit = function(e) {
      if(addHint.textContent) {
        e.preventDefault();
        addHint.style.color = 'red';
        return false;
      }
      e.preventDefault();
      const username = document.getElementById('new-username').value;
      const password = document.getElementById('new-password').value;
      const role = document.getElementById('new-role').value;
      const courseId = document.getElementById('new-course').value;
      fetch('/register', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:`username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&role=${encodeURIComponent(role)}`
      }).then(r=>r.text()).then(msg => {
        const el = document.getElementById('add-user-msg');
        if(msg.includes('Username già esistente')) {
          el.innerHTML = '<span style="color:red">Username già esistente!</span>';
        } else if(msg.includes('window.location') || msg==='OK') {
          el.innerHTML = '<span style="color:green">Utente creato!</span>';
          this.reset();
          setTimeout(fetchUsers, 300);
          if(role==='user' && courseId) {
            setTimeout(()=>{
              const user = users.find(u=>u.username===username);
              if(user) assignCourse(user.id, courseId);
            }, 500);
          }
        } else {
          el.innerHTML = '<span style="color:red">'+msg+'</span>';
        }
        setTimeout(()=>{el.textContent='';}, 2500);
      });
    };
    fetchCourses().then(fetchUsers);
  </script>
</body>
</html> 